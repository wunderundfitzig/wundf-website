name: deploy cms (backend.wunderundfitzig.de)

on:
  push:
    branches:
      - main
      - dev
    paths:
      - backend/**
      - .github/workflows/deploy-cms.yml

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: cms/production
      url: https://backend.wunderundfitzig.de

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.9.1
        with:
          access_token: ${{ github.token }}

      - uses: actions/checkout@v2

      # - uses: php-actions/composer@v6
      #   with:
      #     php_extensions: gd
      #     dev: no
      #     args: --working-dir backend

      # - name: Create .env file
      #   working-directory: backend
      #   run: |
      #     echo "INSTAGRAM_CLIENT_SECRET=${INSTAGRAM_CLIENT_SECRET}" >> .env
      #     echo "ENVIRONMENT=production" >> .env
      #   env:
      #     INSTAGRAM_CLIENT_SECRET: ${{secrets.INSTAGRAM_CLIENT_SECRET}}

      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@v2.2.11
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PRIVATE_SSH_DEPLOY_KEY }}
          ARGS: "-rltgoDzvO --delete --exclude-from=backend/.deployignore"
          SOURCE: "backend/"
          REMOTE_HOST: wfweb.uber.space
          REMOTE_USER: wfweb
          TARGET: "html"
